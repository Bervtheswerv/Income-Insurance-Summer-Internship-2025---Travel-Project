{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "d88dbfbe",
   "metadata": {},
   "source": [
    "# **README - Repeat Purchase Pipeline**\n",
    "\n",
    "For each customer's first purchase within a period, the script creates features by looking backwards (historical) and forwards (future) within a 1-year window. This pipeline analyses customer repeat purchase patterns across two defined periods.\n",
    "\n",
    "- **Period 1**: June 2022 - May 2023  \n",
    "- **Period 2**: June 2023 - May 2024\n",
    "\n",
    "It handles temporal relationships by creating lookback features (pre-purchase behaviour) and lookahead features (post-purchase outcomes). Finally, it consolidates these into period-neutral features that will be used for modelling. The end goal is producing a customer-level dataet where each row represents a customer's first purchase in either period, enriched with their historical behaviour patterns and subsequent purchase outcomes. It also includes the raw features from the original input dataset.\n",
    "\n",
    "## 1. Usage\n",
    "\n",
    "```python\n",
    "from optimised_pipeline import memory_efficient_repeat_purchase_pipeline\n",
    "\n",
    "# Process your data (file_path names can be changed)\n",
    "results = memory_efficient_repeat_purchase_pipeline('travelpolicies_data.csv')\n",
    "results.to_csv('repeat_purchase_features.csv', index=False)\n",
    "```\n",
    "\n",
    "## 2. Feature Output\n",
    "\n",
    "The pipeline creates these exact features for model training:\n",
    "\n",
    "### **A) Target Variable**\n",
    "- `repeat_purchase_final` - Boolean flag (1 if customer purchased again within 1 year, 0 if otherwise)\n",
    "\n",
    "### **B) Categorical Features**\n",
    "**Pre-period (Historical):**\n",
    "- `Region_[ASEAN/ASIA/WORLDWIDE]_pre_final` - Geographic regions\n",
    "- `plantype_fgi_[Individual/Group/Family]_pre_final` - Plan types\n",
    "- `Coverage_final_[Classic/Deluxe/Preferred]_pre_final` - Coverage levels\n",
    "\n",
    "**Post-period (Future):**\n",
    "- `Region_[ASEAN/ASIA/WORLDWIDE]_post_final` - Geographic regions  \n",
    "- `plantype_fgi_[Individual/Group/Family]_post_final` - Plan types\n",
    "- `Coverage_final_[Classic/Deluxe/Preferred]_post_final` - Coverage levels\n",
    "\n",
    "### **Numerical Features** (Averaged)\n",
    "**Pre-period:**\n",
    "- `Claim_count_avg_pre_final` - Average claims per policy\n",
    "- `Discounts_avg_pre_final` - Average discount amount\n",
    "- `Advance_purchase_avg_pre_final` - Days purchased in advance\n",
    "- `trip_duration_avg_pre_final` - Average trip length\n",
    "- `Insured_Premium_avg_pre_final` - Average premium amount\n",
    "- `Tenure_Years_avg_pre_final` - Customer tenure\n",
    "- `claim_close_days_avg_pre_final` - Days to close claims\n",
    "\n",
    "**Post-period:**\n",
    "- `Claim_count_avg_post_final` - Average claims per policy\n",
    "- `Discounts_avg_post_final` - Average discount amount\n",
    "- `Advance_purchase_avg_post_final` - Days purchased in advance\n",
    "- `trip_duration_avg_post_final` - Average trip length\n",
    "- `Insured_Premium_avg_post_final` - Average premium amount\n",
    "- `Tenure_Years_avg_post_final` - Customer tenure\n",
    "- `claim_close_days_avg_post_final` - Days to close claims\n",
    "\n",
    "### **Behavioural Features**\n",
    "- `policies_pre_final` - Number of policies before first purchase\n",
    "- `policies_post_final` - Number of policies after first purchase\n",
    "- `family_flag_pre_final` - Boolean flag for family coverage (pre-period)\n",
    "- `family_flag_post_final` - Boolean flag for family coverage (post-period)\n",
    "\n",
    "### **Identifier Columns**\n",
    "- `InsuredNric` - Customer identifier\n",
    "- `analysis_period` - Whether the first purchase was made in Period1 or Period2\n",
    "\n",
    "## 3. Configuration\n",
    "\n",
    "To modify the pipeline, edit these constants:\n",
    "\n",
    "```python\n",
    "# Analysis periods\n",
    "PERIOD1_START = pd.to_datetime('2022-06-01')\n",
    "PERIOD1_END = pd.to_datetime('2023-05-30')\n",
    "PERIOD2_START = pd.to_datetime('2023-06-01') \n",
    "PERIOD2_END = pd.to_datetime('2024-05-30')\n",
    "\n",
    "# Feature windows\n",
    "LOOKBACK_DAYS = 366\n",
    "LOOKAHEAD_DAYS = 366\n",
    "\n",
    "# Feature columns\n",
    "CATEGORICAL_COLUMNS = {'Region': 'Region', 'plantype_fgi': 'plantype_fgi', 'Coverage_final': 'Coverage_final'}\n",
    "NUMERICAL_COLUMNS = ['Claim_count', 'Discounts', 'Advance_purchase', 'trip_duration', 'Insured_Premium', 'Tenure_Years', 'claim_close_days']\n",
    "\n",
    "# Main runner = file input/output path\n",
    "if __name__ == '__main__':\n",
    "    input_file = '/home/glue_user/workspace/jupyter_workspace/Repeat_Purchase_Model/Input_Data/Actual/travelpolicies_2013_2025may.csv'\n",
    "    output_file = '/home/glue_user/workspace/jupyter_workspace/Repeat_Purchase_Model/Output_Data/repeat_purchase_optimised.csv'\n",
    "```\n",
    "\n",
    "## 4. Key Modification Points\n",
    "\n",
    "1. **Date Periods**: Change `PERIOD1_START`, `PERIOD2_START`, etc. constants\n",
    "2. **Feature Columns**: Modify `CATEGORICAL_COLUMNS` and `NUMERICAL_COLUMNS` dictionaries\n",
    "3. **Feature Creation**: Update `create_period_features_direct()` function\n",
    "4. **Analysis Window**: Adjust `LOOKBACK_DAYS` and `LOOKAHEAD_DAYS` constants"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5313d996",
   "metadata": {},
   "source": [
    "# **READMETOO - Technical Documentation**\n",
    "\n",
    "## 1. Script Architecture & Function Flow\n",
    "\n",
    "```python\n",
    "├── Input CSV Data\n",
    "├── repeat_purchase_pipeline() → Main script runner, data flow from here\n",
    "├── calculate_first_purchase_dates()  → df with first purchase dates\n",
    "├── calculate_repeat_purchase_flags() → df with repeat purchase indicators\n",
    "├── create_period_features_direct() → [Period 1 & 2] customer features + raw data\n",
    "└── Final Combined Dataset (Raw + Engineered Features)\n",
    "```\n",
    "\n",
    "## 2. Core Functions\n",
    "\n",
    "### `repeat_purchase_pipeline()`\n",
    "**Purpose**: Main orchestrator that controls the entire feature engineering process<p>\n",
    "**Inputs**: CSV file path, customer ID column, purchase date column<p>\n",
    "**Returns**: Final dataset with raw data + engineered features<p>\n",
    "**Role**: Coordinates all processing steps, loads data, manages the two-period analysis, and combines results<p>\n",
    "**Key Logic**: Processes periods separately to minimize memory usage, preserves original data structure<p>\n",
    "\n",
    "### `calculate_first_purchase_dates()`\n",
    "**Purpose**: Identifies each customer's first purchase within defined time periods<p>\n",
    "**Inputs**: Customer transaction data with dates<p>\n",
    "**Returns**: Original data + two new columns with first purchase dates per period<p>\n",
    "**Role**: Foundation step that establishes customer analysis windows<p>\n",
    "**Key Logic**: Groups transactions by customer, finds minimum date within Period 1 (Jun 2022-May 2023) and Period 2 (Jun 2023-May 2024)<p>\n",
    "\n",
    "### `calculate_repeat_purchase_flags()`\n",
    "**Purpose**: Determines if customers made repeat purchases within 366 days<p>\n",
    "**Inputs**: Data with first purchase dates<p>\n",
    "**Returns**: Data + binary flags indicating repeat purchase behavior<p>\n",
    "**Role**: Creates the target variable for predictive modeling<p>\n",
    "**Key Logic**: Compares each customer's next purchase date against their first purchase, flags as repeat if within time window<p>\n",
    "\n",
    "### `create_period_features_direct()`\n",
    "**Purpose**: Generates behavioral features by analyzing customer activity before and after first purchase<p>\n",
    "**Inputs**: Full dataset, period number (1 or 2)<p>\n",
    "**Returns**: Customer records with original data + engineered features<p>\n",
    "**Role**: Core feature engineering engine that creates model-ready variables<p>\n",
    "\n",
    "**Key Logic**: \n",
    "- **Lookback Analysis**: Examines 366 days before first purchase (historical behavior)\n",
    "- **Lookahead Analysis**: Examines 366 days after first purchase (future behavior)\n",
    "- **Feature Creation**: Transforms raw transactions into aggregated patterns\n",
    "\n",
    "## 3. Feature Engineering Process\n",
    "\n",
    "### Data Transformation Steps\n",
    "1. **Customer Identification**: Extract customers with first purchases in each period\n",
    "2. **Time Window Creation**: Define lookback (historical) and lookahead (future) periods\n",
    "3. **Data Filtering**: Separate transactions within analysis windows\n",
    "4. **Feature Aggregation**: Convert individual transactions into customer-level patterns\n",
    "\n",
    "### Feature Types Generated\n",
    "\n",
    "**Categorical Features** (One-hot encoding: converts text categories into boolean columns)\n",
    "- **Pre-period**: `Region_Asia_pre_final`, `plantype_fgi_Basic_pre_final` (historical preferences)\n",
    "- **Post-period**: `Region_Asia_post_final`, `plantype_fgi_Basic_post_final` (future patterns)\n",
    "\n",
    "**Numerical Features** (Averaging: calculates mean values across multiple transactions)\n",
    "- **Pre-period**: `Claim_count_avg_pre_final`, `trip_duration_avg_pre_final` (historical averages)\n",
    "- **Post-period**: `Claim_count_avg_post_final`, `trip_duration_avg_post_final` (future averages)\n",
    "\n",
    "**Behavioral Features** (Counting and flagging: identifies specific customer behaviors)\n",
    "- **Policy Counts**: `policies_pre_final`, `policies_post_final` (transaction frequency)\n",
    "- **Family Indicators**: `family_flag_pre_final`, `family_flag_post_final` (coverage type patterns)\n",
    "\n",
    "### Memory Efficiency Strategy\n",
    "- **Direct Feature Creation**: Creates final features immediately without storing intermediate calculations\n",
    "- **Period Separation**: Processes Period 1 and Period 2 independently to reduce peak memory usage\n",
    "- **Selective Processing**: Only analyzes customers relevant to each period rather than entire dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ec826a06",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "language_info": {
   "name": "python"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
